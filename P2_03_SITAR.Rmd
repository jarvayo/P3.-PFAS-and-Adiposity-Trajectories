#####                    #####
##### RUN SITAR ANALYSIS #####
#####                    #####

```{r}
##### LOAD PACKAGES
library("nlme")
library("sitar")
library("data.table")
library("ggplot2")
library("tidyr")

```

```{r}
##### LOAD DATASET
PFAS <- read.csv("C:/Users/jarva/Desktop/James-Todd Lab/P2.PFASandWeightTrajectories/Data/PFAS.csv")

# ##### LOAD WORKSPACE
# load("C:/Users/jarva/Desktop/James-Todd Lab/P2.PFASandWeightTrajectories/Data/P2_SITAR.Rdata")

```

```{r}
##### SUBSET ONLY VARIABLES NEEDED FOR SITAR
SITAR <- subset(PFAS, select = c(aid, DPP_RAV1, DPP_RAV2, DPP_RAV3, DPP_RAV4, AGE_RAV1, 
                                      AGE_RAV2, AGE_RAV3, AGE_RAV4, WT_RAV1, WT_RAV2, WT_RAV3, WT_RAV4)) 

##### CONVERT DATASET FROM WIDE TO LONG FORMAT
SITAR$aid <- as.factor(SITAR$aid)

# BY DAYS post index pregnancy
SITAR_DPP <- gather(SITAR, DPP, WEIGHT, WT_RAV1:WT_RAV4, factor_key=TRUE)
SITAR_DPP <- SITAR_DPP[order(SITAR_DPP$aid),]
SITAR_DPP$DPP <- ifelse(SITAR_DPP$DPP == "WT_RAV1", SITAR_DPP$DPP_RAV1,
                         ifelse(SITAR_DPP$DPP == "WT_RAV2", SITAR_DPP$DPP_RAV2,
                                ifelse(SITAR_DPP$DPP == "WT_RAV3", SITAR_DPP$DPP_RAV3,
                                       ifelse(SITAR_DPP$DPP == "WT_RAV4", SITAR_DPP$DPP_RAV4, NA))))
SITAR_DPP <- subset(SITAR_DPP, select = c(aid, DPP, WEIGHT))
SITAR_DPP <- na.omit(SITAR_DPP)

# # BY AGE
# SITAR_AGE <- gather(SITAR, AGE, WEIGHT, WT_RAV1:WT_RAV4, factor_key=TRUE)
# SITAR_AGE <- SITAR_AGE[order(SITAR_AGE$aid),]
# SITAR_AGE$AGE <- ifelse(SITAR_AGE$AGE == "WT_RAV1", SITAR_AGE$AGE_RAV1,
#                          ifelse(SITAR_AGE$AGE == "WT_RAV2", SITAR_AGE$AGE_RAV2,
#                                 ifelse(SITAR_AGE$AGE == "WT_RAV3", SITAR_AGE$AGE_RAV3,
#                                        ifelse(SITAR_AGE$AGE == "WT_RAV4", SITAR_AGE$AGE_RAV4, NA))))
# SITAR_AGE <- subset(SITAR_AGE, select = c(aid, AGE, WEIGHT))
# SITAR_AGE <- na.omit(SITAR_AGE)

```

```{r}
##### IDENTIFY WEIGHT MEASUREMENT OUTLIERS
outliers_dpp <- velout(x = DPP, y = WEIGHT, id = aid, data = SITAR_DPP, limit = 3)

## SET 105 WEIGHT OUTLIERS MISSING
SIT_DPP <- zapvelout(outliers_dpp, icode = c(4))
SIT_DPP <- subset(SIT_DPP, !is.na(SIT_DPP$WEIGHT))

# outliers_age <- velout(x = AGE, y = WEIGHT, id = aid, data = SITAR_AGE, limit = 3)
# 
# ## SET 114 WEIGHT OUTLIERS MISSING
# SIT_AGE <- zapvelout(outliers_age, icode = c(4, 6))
# SIT_AGE <- subset(SIT_AGE, !is.na(SIT_AGE$WEIGHT))

```

```{r}
##### CHECK DEGREES OF FREEDOM
# dfset(AGE, WEIGHT, SIT_AGE, FUN = BIC) # DF = 2
dfset(DPP, WEIGHT, SIT_DPP, FUN = BIC) # DF = 1

```

```{r}
##### FIT SITAR MODEL
m1_wt <- sitar(x = DPP, y = WEIGHT, id = aid, df = 2, data = SIT_DPP, fixed='a', random='a+c')

##### SUMMARIES
#print(m1_wt)
summary(m1_wt)

```

```{r}
##### SAVE WORKSPACE FOR SITAR
save(m1_wt, file="C:/Users/jarva/Desktop/James-Todd Lab/P2.PFASandWeightTrajectories/Data/P2_SITAR.Rdata")

```

```{r}
##### RANDOM EFFECTS FOR SYSTOLIC AND DIASTOLIC BP
# ranef(m1_wt) # SITAR random effects

# ATTACH THE RANDOM EFFECTS A AND C TO THE DATASET
random_coef <- as.data.frame(m1_wt$coefficients$random$id)
random_coef$aid <- as.numeric(rownames(random_coef))
SIT_DPP <- merge(SIT_DPP, random_coef, by = "aid")
fit_wt<-m1_wt$fitted

# RENAME THE COLUMNS IN m2_wc$FITTED FROM "FIXED" AND "ID" TO "SYS FIXED EFFECTS" AND "SYS PREDICTED"
colnames(fit_wt)<-c("WT_FixedEffect","WT_Predicted")
SIT_DPP_R <- cbind(SIT_DPP,fit_wt)
SIT_DPP_R$a_wt <- SIT_DPP_R$a
SIT_DPP_R$c_wt <- SIT_DPP_R$c

# ASSESS DISTRIBUTION OF RANDOM EFFECTS
hist(SIT_DPP_R$a_wt)
hist(SIT_DPP_R$c_wt)

```

```{r}
##### UNADJUSTED AND ADJUSTED PFAS PLOTS
mplot(x = DPP, y = WEIGHT, id = aid, col = aid, data = SIT_DPP,
      las = 1, cex.lab = 1.5, cex.axis = 1.5, 
      ylab = "Weight (kg)", xlab = "Time post index pregnancy (years)",
      main = "Undjusted Weight Trajectories")

plot(m1_wt, opt = 'a', las = 1, cex.lab = 1.5, cex.axis = 1.5, col = aid, 
     ylab = "Weight (kg)", xlab = "Time post index pregnancy (years)",
     main = "Adjusted Weight Trajectories")

```

```{r}
##### SITAR MEAN SYSTOLIC BP TRAJECTORY AND MEAN TRAJECTORY VELOCITY PLOTS
plot(m1_wt, opt = 'dv', las = 1, col = "deepskyblue3", lwd = 3, 
     ylab = "Weight (kg)", xlab = "Time post index pregnancy (years)",
     main = "Mean Weight Trajectory and Mean Weight Trajectory Velocity", cex.axis = 1, cex.lab = 1)
legend('topleft', legend = c("Weight (kg)", "Weight velocity (kg/year)"), 
       text.col = c("deepskyblue3", "navyblue"),lty=1:5, col = c("deepskyblue3", "navyblue"), cex = 1, inset=0.04)


plot(m1_wt, opt = 'd', las = 1, col = "deepskyblue3", lwd = 3, lty = 1,
     ylab = "Weight (kg)", xlab = "Time post index pregnancy (years)",
     main = "Mean Weight Trajectory and Mean Weight Trajectory Velocity", cex.axis = 1, cex.lab = 1)
par(new = T)
plot(m1_wt, opt = 'v', xlab = '', ylab = '', las = 1, col = "navyblue", lwd = 3, lty = 5, axes = FALSE, 
     cex.axis = 1, cex.lab = 1, bty = "n")
axis(side = 4, las = 1)
mtext("Weight velocity (kg/year)", side = 4, line = 3)
legend('topleft', legend = c("Weight (kg)", "Weight velocity (kg/year)"), 
       text.col = c("deepskyblue3", "navyblue"),lty=1:5, col = c("deepskyblue3", "navyblue"), cex = 1, inset=0.04)

```

```{r}
##### SITAR MEAN WEIGHT TRAJECTORY AND 95% CI
plot(m1_wt, opt = 'd', las = 1, apv = F, ylab = "Weight (kg)", xlab = "Time post index pregnanacy (years)", 
     ylim = c(30, 140), y2par = list(lwd = 2), lwd = 2.5, main = "Mean Weight Trajectory (95% CI)")
lines(m1_wt, opt = 'd', y2par = list(col = 'deeppink', lwd = 2), 
      apv = F, lwd = 2, lty = 2, col = 'deeppink', abc=(sqrt(diag(getVarCov(m1_wt)))*1.96))
lines(m1_wt, opt = 'd', y2par = list(col = 'deeppink', lwd = 2), 
      apv = F, lwd = 2, lty = 2, col = 'deeppink', abc=(sqrt(diag(getVarCov(m1_wt)))*-1.96))
# legend("topleft", c( "Mean change trajectory", "Upper 95% CI", "Lower 95% CI"),
#        col = c("black", "deeppink", "turquoise3"), lty = c(1, 2, 2))

```


```{r}
##### GOODNESS OF FIT PLOT FOR SITAR MODELLING
plot(WEIGHT ~ DPP, data = SIT_DPP_R, las = 1, col = "lightblue4", ylim = c(30,170),
     ylab = "Weight (kg)", xlab = "Time post index pregnancy (years)",
     main = "Goodness of Fit Plot for SITAR Modeling")
lines(m1_wt, opt = 'D', lty = 1, col="darkturquoise")
lines(m1_wt, opt = 'd', lwd=2, lty = 2, col="red")
legend('bottomright', c('Observed', 'Fitted trajectory', 'SITAR mean trajectory'),
       lty = c(NA, 1, 2), pch=c(1,NA,NA), col = c("lightblue4", "turquoise4", "red"), cex = 0.8, inset=0.04) 

```

```{r}
##### ADD A "DUP" VARIABLE TO COUNT NUMBER OF DUPLICATED IDs
SIT_DPP_R$dup_num <- length(unique(SIT_DPP_R$DPP)) == nrow(SIT_DPP_R)
SIT_DPP_R$dup_num <- sequence(table(SIT_DPP_R$aid))

##### SAVE DATASET
SIT_DPP_R <- subset(SIT_DPP_R, dup_num == 1)
SIT_DPP_R <- subset(SIT_DPP_R, select = c(aid, a_wt,c_wt))

write.csv(SIT_DPP_R, file = "C:/Users/jarva/Desktop/James-Todd Lab/P2.PFASandWeightTrajectories/Data/P2_SITAR.csv", row.names = T)

```
